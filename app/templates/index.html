<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Stem Splitter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stem-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stem-card:hover {
            border-color: rgba(99, 102, 241, 0.5);
        }
        audio {
            width: 100%;
            height: 40px;
        }
        audio::-webkit-media-controls-panel {
            background: rgba(255, 255, 255, 0.1);
        }
        .upload-zone {
            border: 2px dashed rgba(99, 102, 241, 0.5);
            transition: all 0.3s ease;
        }
        .upload-zone:hover, .upload-zone.drag-over {
            border-color: rgba(99, 102, 241, 1);
            background: rgba(99, 102, 241, 0.1);
        }
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .stem-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 24px;
        }
        .spectrogram-loading {
            background: linear-gradient(90deg, rgba(99,102,241,0.1) 25%, rgba(99,102,241,0.2) 50%, rgba(99,102,241,0.1) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .crate-chevron {
            transition: transform 0.2s ease;
        }
        .crate-row-header:hover {
            background: rgba(255, 255, 255, 0.08);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen font-sans text-white">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
                Audio Stem Splitter
            </h1>
            <p class="text-gray-400 text-lg">
                Separate your audio into individual stems using AI
            </p>
        </header>

        <!-- Upload Section -->
        <div id="upload-section" class="glass rounded-2xl p-8 mb-8">
            <form id="upload-form" class="space-y-6">
                <!-- Tabs -->
                <div class="flex space-x-2 mb-6">
                    <button type="button" id="tab-file" onclick="switchTab('file')"
                            class="px-6 py-2 rounded-lg font-medium transition-all bg-indigo-600 text-white">
                        Upload File
                    </button>
                    <button type="button" id="tab-url" onclick="switchTab('url')"
                            class="px-6 py-2 rounded-lg font-medium transition-all bg-white/10 text-gray-300 hover:bg-white/20">
                        Paste URL
                    </button>
                </div>

                <!-- File Upload -->
                <div id="file-section">
                    <div id="upload-zone" class="upload-zone rounded-xl p-8 text-center cursor-pointer"
                         onclick="document.getElementById('file-input').click()">
                        <input type="file" id="file-input" name="file" accept="audio/*" class="hidden">
                        <div class="space-y-4">
                            <div class="w-16 h-16 mx-auto rounded-full bg-indigo-600/20 flex items-center justify-center">
                                <svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                            </div>
                            <div>
                                <p class="text-lg font-medium text-gray-200" id="file-label">
                                    Drop your audio file here or click to browse
                                </p>
                                <p class="text-sm text-gray-500 mt-1">
                                    Supports MP3, WAV, FLAC, and more
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- URL Input -->
                <div id="url-section" class="hidden">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-300">Audio URL</label>
                        <input type="url" id="url-input" name="url" placeholder="https://youtube.com/watch?v=... or SoundCloud URL"
                               class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white placeholder-gray-500
                                      focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all">
                        <p class="text-sm text-gray-500">
                            Works with YouTube, SoundCloud, and many other platforms
                        </p>
                    </div>
                    <!-- Fetch Button for URL tab -->
                    <button type="button" id="fetch-url-btn" onclick="fetchFromUrl()"
                            class="mt-4 w-full py-3 px-6 rounded-xl font-semibold text-white bg-gradient-to-r from-emerald-600 to-teal-600
                                   hover:from-emerald-500 hover:to-teal-500 transition-all transform hover:scale-[1.02]
                                   focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 focus:ring-offset-transparent
                                   disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                        <span id="fetch-btn-text">Fetch Audio</span>
                    </button>
                </div>

                <!-- Audio Preview (hidden until file selected/URL fetched) -->
                <div id="preview-section" class="hidden mt-6">
                    <div class="glass rounded-xl p-4 space-y-4">
                        <!-- Track Info (shown for URL fetches with cover art) -->
                        <div id="track-info" class="hidden flex items-center space-x-4 pb-4 border-b border-white/10">
                            <img id="track-thumbnail" class="w-16 h-16 rounded-lg object-cover shadow-lg" alt="Cover art" />
                            <div class="flex-1 min-w-0">
                                <h3 id="track-title" class="font-semibold text-white truncate"></h3>
                                <p id="track-artist" class="text-sm text-gray-400 truncate"></p>
                            </div>
                        </div>

                        <!-- Waveform -->
                        <div id="waveform" class="w-full rounded-lg overflow-hidden"></div>
                        <div id="waveform-loading" class="h-24 rounded-lg spectrogram-loading"></div>

                        <!-- Playback Controls -->
                        <div class="flex items-center space-x-3">
                            <button id="play-btn" type="button"
                                    class="p-3 rounded-full bg-indigo-600 hover:bg-indigo-500 transition-all">
                                <svg id="play-icon" class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                                <svg id="pause-icon" class="w-5 h-5 text-white hidden" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                                </svg>
                            </button>
                            <div id="current-time" class="text-sm text-gray-400 font-mono w-20">0:00</div>
                            <div class="flex-1"></div>
                            <div id="duration" class="text-sm text-gray-400 font-mono">0:00</div>
                        </div>

                        <!-- BPM Display -->
                        <div class="flex items-center justify-between pt-2 border-t border-white/10">
                            <span class="text-gray-400">Detected Tempo</span>
                            <span id="bpm-display" class="text-2xl font-bold text-indigo-400">-- BPM</span>
                        </div>
                    </div>
                </div>

                <!-- Stem Selection -->
                <div class="space-y-3">
                    <label class="text-sm font-medium text-gray-300">Number of Stems</label>
                    <div class="grid grid-cols-3 gap-3">
                        <label class="cursor-pointer">
                            <input type="radio" name="num_stems" value="2" class="hidden peer" checked>
                            <div class="p-4 rounded-xl border border-white/10 peer-checked:border-indigo-500
                                        peer-checked:bg-indigo-500/10 transition-all text-center">
                                <div class="text-2xl font-bold text-indigo-400">2</div>
                                <div class="text-xs text-gray-400 mt-1">Vocals + Music</div>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="num_stems" value="4" class="hidden peer">
                            <div class="p-4 rounded-xl border border-white/10 peer-checked:border-indigo-500
                                        peer-checked:bg-indigo-500/10 transition-all text-center">
                                <div class="text-2xl font-bold text-purple-400">4</div>
                                <div class="text-xs text-gray-400 mt-1">Vocals, Drums, Bass, Other</div>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="num_stems" value="5" class="hidden peer">
                            <div class="p-4 rounded-xl border border-white/10 peer-checked:border-indigo-500
                                        peer-checked:bg-indigo-500/10 transition-all text-center">
                                <div class="text-2xl font-bold text-pink-400">5</div>
                                <div class="text-xs text-gray-400 mt-1">+ Piano</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submit-btn"
                        class="w-full py-4 px-6 rounded-xl font-semibold text-white bg-gradient-to-r from-indigo-600 to-purple-600
                               hover:from-indigo-500 hover:to-purple-500 transition-all transform hover:scale-[1.02]
                               focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-transparent
                               disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                    <span id="btn-text">Split Audio</span>
                </button>
            </form>
        </div>

        <!-- Processing Status -->
        <div id="status-section" class="hidden glass rounded-2xl p-8 mb-8">
            <div class="flex items-center space-x-4">
                <div class="spinner"></div>
                <div>
                    <p class="font-medium text-lg" id="status-title">Processing...</p>
                    <p class="text-gray-400" id="status-message">Initializing...</p>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">Your Stems</h2>
                <button onclick="resetForm()" class="px-4 py-2 rounded-lg text-sm font-medium text-gray-300
                                                     bg-white/10 hover:bg-white/20 transition-all">
                    Split Another
                </button>
            </div>
            <div id="stems-grid" class="grid gap-4">
                <!-- Stems will be inserted here -->
            </div>
        </div>

        <!-- Error Section -->
        <div id="error-section" class="hidden glass rounded-2xl p-8 mb-8 border border-red-500/50">
            <div class="flex items-start space-x-4">
                <div class="w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0">
                    <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div>
                    <p class="font-medium text-lg text-red-400">Error</p>
                    <p class="text-gray-400" id="error-message">Something went wrong</p>
                    <button onclick="resetForm()" class="mt-4 px-4 py-2 rounded-lg text-sm font-medium text-white
                                                         bg-red-500 hover:bg-red-600 transition-all">
                        Try Again
                    </button>
                </div>
            </div>
        </div>

        <!-- Crate Section -->
        <div id="crate-section" class="hidden glass rounded-2xl p-8 mb-8">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg bg-indigo-500/20 flex items-center justify-center">
                        <span class="text-xl">üì¶</span>
                    </div>
                    <h2 class="text-2xl font-bold text-white">Your Crate</h2>
                </div>
                <span id="crate-count" class="text-gray-400 text-sm">0 tracks</span>
            </div>
            <div id="crate-list" class="space-y-3">
                <!-- Track rows inserted here -->
            </div>
        </div>

        <!-- Samples Section -->
        <div id="samples-section" class="hidden glass rounded-2xl p-8 mb-8">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                        <span class="text-xl">‚úÇÔ∏è</span>
                    </div>
                    <h2 class="text-2xl font-bold text-white">Samples</h2>
                </div>
                <span id="samples-count" class="text-gray-400 text-sm">0 samples</span>
            </div>
            <div id="samples-list" class="grid gap-3">
                <!-- Sample cards inserted here -->
            </div>
        </div>

        <!-- Loops Section -->
        <div id="loops-section" class="hidden glass rounded-2xl p-8 mb-8">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center">
                        <span class="text-xl">üîÅ</span>
                    </div>
                    <h2 class="text-2xl font-bold text-white">Loops</h2>
                </div>
                <span id="loops-count" class="text-gray-400 text-sm">0 loops</span>
            </div>
            <div id="loops-list" class="grid gap-3">
                <!-- Loop cards inserted here -->
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center text-gray-500 text-sm mt-12">
            <p>Powered by <a href="https://github.com/deezer/spleeter" class="text-indigo-400 hover:underline">Spleeter</a></p>
        </footer>
    </div>

    <script>
        const stemIcons = {
            vocals: { emoji: 'üé§', color: 'bg-pink-500/20', text: 'text-pink-400' },
            accompaniment: { emoji: 'üéµ', color: 'bg-blue-500/20', text: 'text-blue-400' },
            drums: { emoji: 'ü•Å', color: 'bg-orange-500/20', text: 'text-orange-400' },
            bass: { emoji: 'üé∏', color: 'bg-green-500/20', text: 'text-green-400' },
            piano: { emoji: 'üéπ', color: 'bg-purple-500/20', text: 'text-purple-400' },
            other: { emoji: 'üéº', color: 'bg-yellow-500/20', text: 'text-yellow-400' }
        };

        let currentTab = 'file';
        let currentJobId = null;
        let pollInterval = null;
        let previewReady = false;
        let urlFetchData = null;  // Stores data from URL fetch for later use
        let wavesurfer = null;    // WaveSurfer instance for preview
        let stemWavesurfers = []; // WaveSurfer instances for stems

        // Crate state
        let crateData = [];
        let expandedTracks = {};
        let crateWavesurfers = {};

        // Samples state
        let samplesData = [];
        let sampleWavesurfers = {};

        // Loops state
        let loopsData = [];
        let loopWavesurfers = {};

        // Track active regions for Esc key clearing
        let activeRegions = {};

        // Track loop preview state
        let loopPreviewState = {
            isLooping: false,
            currentId: null,
            wavesurfer: null
        };

        // Stop loop preview
        function stopLoopPreview() {
            if (loopPreviewState.isLooping && loopPreviewState.wavesurfer) {
                loopPreviewState.wavesurfer.pause();
                loopPreviewState.isLooping = false;
                // Update UI
                const popup = document.getElementById(`loop-popup-${loopPreviewState.currentId}`);
                if (popup) {
                    popup.querySelector('.loop-play-btn').classList.remove('hidden');
                    popup.querySelector('.loop-stop-btn').classList.add('hidden');
                }
                loopPreviewState.currentId = null;
                loopPreviewState.wavesurfer = null;
            }
        }

        // Global Escape key handler to clear regions and stop loop preview
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Stop any loop preview
                stopLoopPreview();

                // Clear all regions and hide popups
                Object.keys(activeRegions).forEach(id => {
                    if (activeRegions[id]) {
                        activeRegions[id].remove();
                        activeRegions[id] = null;
                        const sampleBtn = document.getElementById(`sample-btn-${id}`);
                        const loopControls = document.getElementById(`loop-controls-${id}`);
                        const loopPopup = document.getElementById(`loop-popup-${id}`);
                        if (sampleBtn) sampleBtn.classList.add('hidden');
                        if (loopControls) loopControls.classList.add('hidden');
                        if (loopPopup) loopPopup.classList.add('hidden');
                    }
                });
            }
        });

        // Helper function to setup manual shift+drag region selection
        function setupRegionSelection(uniqueId, wavesurfer, regions, onRegionCreated, onRegionUpdated) {
            const waveformEl = document.getElementById(`waveform-${uniqueId}`);
            const waveformContainer = waveformEl.parentElement;
            let isDragging = false;
            let startTime = 0;
            let startX = 0;
            let previewEl = null;

            // Create preview overlay element
            function createPreviewOverlay() {
                const overlay = document.createElement('div');
                overlay.className = 'absolute top-0 h-full pointer-events-none rounded';
                overlay.style.backgroundColor = 'rgba(16, 185, 129, 0.3)';
                overlay.style.border = '1px solid rgba(16, 185, 129, 0.6)';
                overlay.style.zIndex = '10';
                return overlay;
            }

            // Create loop preview popup with precision time controls
            function createLoopPopup() {
                const existingPopup = document.getElementById(`loop-popup-${uniqueId}`);
                if (existingPopup) existingPopup.remove();

                const region = activeRegions[uniqueId];
                const startVal = region ? formatTimePrecise(region.start) : '0:00.000';
                const endVal = region ? formatTimePrecise(region.end) : '0:00.000';

                const popup = document.createElement('div');
                popup.id = `loop-popup-${uniqueId}`;
                popup.className = 'absolute flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-800/95 border border-emerald-500/50 shadow-lg z-20';
                popup.style.top = '-52px';
                popup.innerHTML = `
                    <!-- Start time control -->
                    <div class="flex items-center gap-1">
                        <span class="text-[10px] text-gray-500 uppercase">Start</span>
                        <div class="flex items-center">
                            <input type="text" class="time-input-start w-[72px] px-1.5 py-0.5 text-xs font-mono text-emerald-400 bg-gray-900/80 border border-gray-700 rounded-l focus:outline-none focus:border-emerald-500" value="${startVal}">
                            <div class="flex flex-col border-y border-r border-gray-700 rounded-r">
                                <button class="time-up-start px-1 py-0 hover:bg-emerald-500/20 text-gray-400 hover:text-emerald-400 transition-colors leading-none" title="Increase">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/>
                                    </svg>
                                </button>
                                <button class="time-down-start px-1 py-0 hover:bg-emerald-500/20 text-gray-400 hover:text-emerald-400 transition-colors leading-none" title="Decrease">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- End time control -->
                    <div class="flex items-center gap-1">
                        <span class="text-[10px] text-gray-500 uppercase">End</span>
                        <div class="flex items-center">
                            <input type="text" class="time-input-end w-[72px] px-1.5 py-0.5 text-xs font-mono text-emerald-400 bg-gray-900/80 border border-gray-700 rounded-l focus:outline-none focus:border-emerald-500" value="${endVal}">
                            <div class="flex flex-col border-y border-r border-gray-700 rounded-r">
                                <button class="time-up-end px-1 py-0 hover:bg-emerald-500/20 text-gray-400 hover:text-emerald-400 transition-colors leading-none" title="Increase">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/>
                                    </svg>
                                </button>
                                <button class="time-down-end px-1 py-0 hover:bg-emerald-500/20 text-gray-400 hover:text-emerald-400 transition-colors leading-none" title="Decrease">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Divider -->
                    <div class="w-px h-6 bg-gray-700"></div>
                    <!-- Loop controls -->
                    <button class="loop-play-btn p-1.5 rounded hover:bg-emerald-500/20 text-emerald-400 transition-colors" title="Loop preview">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m3.81.086a.5.5 0 0 1 .67.225A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.25.25 0 0 1 0-.384l2.36-1.966a.25.25 0 0 1 .41.192V12h6a4 4 0 0 0 3.585-5.777.5.5 0 0 1 .225-.67Z"/>
                        </svg>
                    </button>
                    <button class="loop-stop-btn hidden p-1.5 rounded hover:bg-red-500/20 text-red-400 transition-colors" title="Stop loop">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="M5 6.5A1.5 1.5 0 0 1 6.5 5h3A1.5 1.5 0 0 1 11 6.5v3A1.5 1.5 0 0 1 9.5 11h-3A1.5 1.5 0 0 1 5 9.5z"/>
                        </svg>
                    </button>
                    <!-- Duration display -->
                    <span class="text-xs text-emerald-400 font-mono loop-duration min-w-[48px]"></span>
                    <!-- Drag handle -->
                    <div class="drag-handle cursor-grab active:cursor-grabbing pl-1 border-l border-gray-700 ml-1 text-gray-500 hover:text-gray-300 transition-colors" title="Drag to move">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
                        </svg>
                    </div>
                `;
                waveformContainer.appendChild(popup);

                // Make popup draggable via drag handle
                const dragHandle = popup.querySelector('.drag-handle');
                let isDraggingPopup = false;
                let dragStartX = 0;
                let dragStartY = 0;
                let popupStartLeft = 0;
                let popupStartTop = 0;

                dragHandle.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    isDraggingPopup = true;
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                    popupStartLeft = popup.offsetLeft;
                    popupStartTop = popup.offsetTop;
                    dragHandle.style.cursor = 'grabbing';
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDraggingPopup) return;
                    const dx = e.clientX - dragStartX;
                    const dy = e.clientY - dragStartY;

                    // Calculate new position
                    let newLeft = popupStartLeft + dx;
                    let newTop = popupStartTop + dy;

                    // Get bounds of the stem card (parent of waveformContainer)
                    const card = waveformContainer.closest('.stem-card');
                    if (card) {
                        const cardRect = card.getBoundingClientRect();
                        const containerRect = waveformContainer.getBoundingClientRect();
                        const popupRect = popup.getBoundingClientRect();

                        // Calculate bounds relative to waveformContainer
                        const minLeft = -(containerRect.left - cardRect.left);
                        const maxLeft = (cardRect.right - containerRect.left) - popupRect.width;
                        const minTop = -(containerRect.top - cardRect.top);
                        const maxTop = (cardRect.bottom - containerRect.top) - popupRect.height;

                        newLeft = Math.max(minLeft, Math.min(newLeft, maxLeft));
                        newTop = Math.max(minTop, Math.min(newTop, maxTop));
                    }

                    popup.style.left = `${newLeft}px`;
                    popup.style.top = `${newTop}px`;
                });

                document.addEventListener('mouseup', () => {
                    if (isDraggingPopup) {
                        isDraggingPopup = false;
                        dragHandle.style.cursor = 'grab';
                        // Mark popup as manually positioned to prevent auto-repositioning
                        popup.manuallyPositioned = true;
                    }
                });

                const startInput = popup.querySelector('.time-input-start');
                const endInput = popup.querySelector('.time-input-end');
                const duration = wavesurfer.getDuration();

                // Increment step in seconds (10ms)
                const STEP = 0.01;

                // Update region from input values
                function updateRegionFromInputs() {
                    const region = activeRegions[uniqueId];
                    if (!region) return;

                    const newStart = parseTimePrecise(startInput.value);
                    const newEnd = parseTimePrecise(endInput.value);

                    if (newStart !== null && newEnd !== null && newStart < newEnd && newStart >= 0 && newEnd <= duration) {
                        region.setOptions({ start: newStart, end: newEnd });
                        updatePopupPosition();
                        if (onRegionUpdated) onRegionUpdated(region);
                    }
                }

                // Update inputs from region
                function updateInputsFromRegion() {
                    const region = activeRegions[uniqueId];
                    if (!region) return;
                    startInput.value = formatTimePrecise(region.start);
                    endInput.value = formatTimePrecise(region.end);
                }

                // Adjust time with bounds checking
                function adjustTime(isStart, delta) {
                    const region = activeRegions[uniqueId];
                    if (!region) return;

                    if (isStart) {
                        const newStart = Math.max(0, Math.min(region.start + delta, region.end - STEP));
                        region.setOptions({ start: newStart });
                    } else {
                        const newEnd = Math.min(duration, Math.max(region.end + delta, region.start + STEP));
                        region.setOptions({ end: newEnd });
                    }
                    updateInputsFromRegion();
                    updatePopupPosition();
                    if (onRegionUpdated) onRegionUpdated(region);
                }

                // Input change handlers
                startInput.addEventListener('change', updateRegionFromInputs);
                endInput.addEventListener('change', updateRegionFromInputs);

                // Prevent space from triggering play/pause when typing
                startInput.addEventListener('keydown', (e) => e.stopPropagation());
                endInput.addEventListener('keydown', (e) => e.stopPropagation());

                // Helper for click-and-hold chevron behavior
                function setupChevronHold(btn, isStart, delta) {
                    let holdInterval = null;
                    const INITIAL_DELAY = 400;  // ms before repeat starts
                    const REPEAT_RATE = 50;     // ms between repeats

                    const startHold = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        adjustTime(isStart, delta);  // Immediate first adjustment

                        // Start repeating after initial delay
                        holdInterval = setTimeout(() => {
                            holdInterval = setInterval(() => {
                                adjustTime(isStart, delta);
                            }, REPEAT_RATE);
                        }, INITIAL_DELAY);
                    };

                    const stopHold = () => {
                        if (holdInterval) {
                            clearTimeout(holdInterval);
                            clearInterval(holdInterval);
                            holdInterval = null;
                        }
                    };

                    btn.addEventListener('mousedown', startHold);
                    btn.addEventListener('mouseup', stopHold);
                    btn.addEventListener('mouseleave', stopHold);
                }

                // Chevron handlers - start time
                setupChevronHold(popup.querySelector('.time-up-start'), true, STEP);
                setupChevronHold(popup.querySelector('.time-down-start'), true, -STEP);

                // Chevron handlers - end time
                setupChevronHold(popup.querySelector('.time-up-end'), false, STEP);
                setupChevronHold(popup.querySelector('.time-down-end'), false, -STEP);

                // Loop play button handler
                popup.querySelector('.loop-play-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    startLoopPreview();
                });

                // Stop button handler
                popup.querySelector('.loop-stop-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    stopLoopPreview();
                });

                // Store updateInputsFromRegion for external use
                popup.updateInputsFromRegion = updateInputsFromRegion;

                return popup;
            }

            // Start loop preview
            function startLoopPreview() {
                const region = activeRegions[uniqueId];
                if (!region) return;

                // Stop any existing loop
                stopLoopPreview();

                loopPreviewState.isLooping = true;
                loopPreviewState.currentId = uniqueId;
                loopPreviewState.wavesurfer = wavesurfer;

                // Update UI
                const popup = document.getElementById(`loop-popup-${uniqueId}`);
                if (popup) {
                    popup.querySelector('.loop-play-btn').classList.add('hidden');
                    popup.querySelector('.loop-stop-btn').classList.remove('hidden');
                }

                // Play region and loop it
                const playLoop = () => {
                    if (loopPreviewState.isLooping && loopPreviewState.currentId === uniqueId) {
                        const currentRegion = activeRegions[uniqueId];
                        if (currentRegion) {
                            wavesurfer.setTime(currentRegion.start);
                            wavesurfer.play();
                        }
                    }
                };

                // Listen for when playback reaches end of region
                const checkPosition = () => {
                    if (!loopPreviewState.isLooping || loopPreviewState.currentId !== uniqueId) return;
                    const currentRegion = activeRegions[uniqueId];
                    if (currentRegion && wavesurfer.getCurrentTime() >= currentRegion.end) {
                        playLoop();
                    }
                    if (loopPreviewState.isLooping) {
                        requestAnimationFrame(checkPosition);
                    }
                };

                playLoop();
                requestAnimationFrame(checkPosition);
            }

            // Update popup position based on region
            function updatePopupPosition() {
                const region = activeRegions[uniqueId];
                const popup = document.getElementById(`loop-popup-${uniqueId}`);
                if (!region || !popup) return;

                // Only auto-position if popup hasn't been manually dragged
                if (!popup.manuallyPositioned) {
                    const duration = wavesurfer.getDuration();
                    const containerWidth = waveformEl.offsetWidth;
                    const regionMidpoint = ((region.start + region.end) / 2 / duration) * containerWidth;
                    const popupWidth = popup.offsetWidth;

                    // Position popup centered above region, but keep within bounds
                    let left = regionMidpoint - (popupWidth / 2);
                    left = Math.max(0, Math.min(left, containerWidth - popupWidth));
                    popup.style.left = `${left}px`;
                }

                // Update duration display
                const durationSpan = popup.querySelector('.loop-duration');
                if (durationSpan) {
                    durationSpan.textContent = `${(region.end - region.start).toFixed(2)}s`;
                }

                // Update input fields if popup has the function
                if (popup.updateInputsFromRegion) {
                    popup.updateInputsFromRegion();
                }
            }

            // Show crosshair cursor when shift is held over waveform
            waveformEl.addEventListener('mouseenter', (e) => {
                if (e.shiftKey) waveformEl.style.cursor = 'crosshair';
            });

            waveformEl.addEventListener('mousemove', (e) => {
                if (!isDragging) {
                    waveformEl.style.cursor = e.shiftKey ? 'crosshair' : 'pointer';
                }
            });

            waveformEl.addEventListener('mousedown', (e) => {
                if (!e.shiftKey) return;
                e.preventDefault();
                e.stopPropagation();

                // Stop any active loop preview
                stopLoopPreview();

                isDragging = true;
                const rect = waveformEl.getBoundingClientRect();
                startX = e.clientX - rect.left;
                const duration = wavesurfer.getDuration();
                startTime = (startX / rect.width) * duration;
                waveformEl.style.cursor = 'crosshair';

                // Create and show preview overlay
                previewEl = createPreviewOverlay();
                previewEl.style.left = `${startX}px`;
                previewEl.style.width = '0px';
                waveformContainer.appendChild(previewEl);

                // Remove existing region and popup
                if (activeRegions[uniqueId]) {
                    activeRegions[uniqueId].remove();
                    activeRegions[uniqueId] = null;
                }
                const existingPopup = document.getElementById(`loop-popup-${uniqueId}`);
                if (existingPopup) existingPopup.classList.add('hidden');
            });

            // Update preview during drag
            const handleMouseMove = (e) => {
                if (!isDragging || !previewEl) return;

                const rect = waveformEl.getBoundingClientRect();
                const currentX = Math.max(0, Math.min(e.clientX - rect.left, rect.width));

                const left = Math.min(startX, currentX);
                const width = Math.abs(currentX - startX);

                previewEl.style.left = `${left}px`;
                previewEl.style.width = `${width}px`;
            };

            document.addEventListener('mousemove', handleMouseMove);

            const handleMouseUp = (e) => {
                if (!isDragging) return;
                isDragging = false;
                waveformEl.style.cursor = 'pointer';

                // Remove preview overlay
                if (previewEl) {
                    previewEl.remove();
                    previewEl = null;
                }

                const rect = waveformEl.getBoundingClientRect();
                const endX = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
                const duration = wavesurfer.getDuration();
                const endTime = (endX / rect.width) * duration;

                // Only create region if there's meaningful selection (> 0.1s)
                const regionStart = Math.min(startTime, endTime);
                const regionEnd = Math.max(startTime, endTime);

                if (regionEnd - regionStart > 0.1) {
                    // Create new region
                    const region = regions.addRegion({
                        start: regionStart,
                        end: regionEnd,
                        color: 'rgba(16, 185, 129, 0.3)',
                        drag: true,
                        resize: true
                    });

                    activeRegions[uniqueId] = region;

                    // Create and show loop popup
                    const popup = createLoopPopup();
                    popup.classList.remove('hidden');
                    updatePopupPosition();

                    if (onRegionCreated) onRegionCreated(region);
                }
            };

            document.addEventListener('mouseup', handleMouseUp);

            // Update popup when region is modified (by dragging)
            regions.on('region-updated', (region) => {
                if (activeRegions[uniqueId] === region) {
                    updatePopupPosition();
                    if (onRegionUpdated) onRegionUpdated(region);
                }
            });
        }

        // Load crate, samples, and loops on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadCrate();
            loadSamples();
            loadLoops();
        });

        async function loadCrate() {
            try {
                const response = await fetch('/crate');
                const data = await response.json();

                if (data.has_output && data.tracks.length > 0) {
                    crateData = data.tracks;
                    renderCrate();
                    document.getElementById('crate-section').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Failed to load crate:', error);
            }
        }

        function renderCrate() {
            const list = document.getElementById('crate-list');
            list.innerHTML = '';

            document.getElementById('crate-count').textContent =
                `${crateData.length} track${crateData.length !== 1 ? 's' : ''}`;

            crateData.forEach((track, index) => {
                const row = document.createElement('div');
                row.className = 'crate-row';
                row.innerHTML = `
                    <div class="crate-row-header glass rounded-xl p-4 cursor-pointer hover:border-indigo-500/50 border border-transparent transition-all"
                         onclick="toggleCrateRow(${track.id}, this)">
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex items-center space-x-4 min-w-0 flex-1">
                                <div class="w-10 h-10 rounded-lg bg-indigo-500/20 flex items-center justify-center flex-shrink-0">
                                    <span class="text-xl">üìÅ</span>
                                </div>
                                <div class="min-w-0">
                                    <h3 class="font-semibold text-white truncate">${track.name}</h3>
                                    <p class="text-sm text-gray-400">${track.stem_count} stems</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-6 text-sm flex-shrink-0">
                                <div class="text-gray-400">
                                    <span class="text-indigo-400 font-mono">${track.bpm ? Math.round(track.bpm) : '‚Äî'}</span> BPM
                                </div>
                                <div class="text-gray-400 font-mono">
                                    ${track.duration ? formatTime(track.duration) : '‚Äî'}
                                </div>
                                <button onclick="event.stopPropagation(); deleteTrack(${track.id}, '${track.name.replace(/'/g, "\\'")}')"
                                        class="p-2 rounded-lg bg-white/5 hover:bg-red-500/20 transition-colors group"
                                        title="Delete track">
                                    <svg class="w-4 h-4 text-gray-400 group-hover:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                                <svg class="w-5 h-5 text-gray-400 transform transition-transform crate-chevron"
                                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="crate-row-content hidden mt-3 ml-4 space-y-3" id="crate-stems-${track.id}">
                        <!-- Stems loaded on expand -->
                    </div>
                `;
                list.appendChild(row);
            });
        }

        async function toggleCrateRow(trackId, headerEl) {
            const content = document.getElementById(`crate-stems-${trackId}`);
            const chevron = headerEl.querySelector('.crate-chevron');

            if (content.classList.contains('hidden')) {
                // Expand
                content.classList.remove('hidden');
                chevron.classList.add('rotate-180');

                if (!expandedTracks[trackId]) {
                    // Load stems on first expand
                    await loadTrackStems(trackId);
                    expandedTracks[trackId] = true;
                }
            } else {
                // Collapse
                content.classList.add('hidden');
                chevron.classList.remove('rotate-180');
            }
        }

        async function loadTrackStems(trackId) {
            const container = document.getElementById(`crate-stems-${trackId}`);
            container.innerHTML = '<div class="text-gray-400 text-sm p-4">Loading stems...</div>';

            try {
                const response = await fetch(`/crate/${trackId}`);
                const track = await response.json();

                container.innerHTML = '';
                crateWavesurfers[trackId] = [];

                // Display original track if available
                if (track.original_filename) {
                    const originalId = `crate-${trackId}-original`;
                    const originalCard = document.createElement('div');
                    originalCard.className = 'stem-card rounded-xl p-4 border border-cyan-500/30';
                    originalCard.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-lg bg-cyan-500/20 flex items-center justify-center">
                                    <span class="text-lg">üíø</span>
                                </div>
                                <span class="font-medium text-cyan-400">Original Track</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="sample-btn-${originalId}"
                                        class="hidden px-3 py-1.5 rounded-lg bg-emerald-500/20 hover:bg-emerald-500/30 transition-colors text-emerald-400 text-sm font-medium"
                                        title="Download selected region as sample">
                                    <span class="flex items-center space-x-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                        </svg>
                                        <span id="sample-btn-text-${originalId}">Sample</span>
                                    </span>
                                </button>
                                <div id="loop-controls-${originalId}" class="hidden flex items-center space-x-1 px-2 py-1 rounded-lg bg-purple-500/20">
                                    <select id="stem-loop-count-${originalId}"
                                            class="bg-transparent text-purple-400 text-xs font-medium focus:outline-none cursor-pointer">
                                        <option value="2">x2</option>
                                        <option value="4" selected>x4</option>
                                        <option value="8">x8</option>
                                        <option value="16">x16</option>
                                    </select>
                                    <button id="stem-loop-btn-${originalId}"
                                            class="text-purple-400 hover:text-purple-300 transition-colors"
                                            title="Create loop from selection">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m3.81.086a.5.5 0 0 1 .67.225A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.25.25 0 0 1 0-.384l2.36-1.966a.25.25 0 0 1 .41.192V12h6a4 4 0 0 0 3.585-5.777.5.5 0 0 1 .225-.67Z"/>
                                        </svg>
                                    </button>
                                </div>
                                <a href="/output/${encodeURIComponent(track.name)}/${track.original_filename}"
                                   download="${track.name} - original${track.original_filename.substring(track.original_filename.lastIndexOf('.'))}"
                                   class="p-2 rounded-lg bg-white/5 hover:bg-white/10 transition-colors"
                                   title="Download original">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">Shift + drag to select region | Esc to clear</div>
                        <div id="waveform-container-${originalId}" class="relative w-full">
                            <div id="waveform-${originalId}" class="w-full h-16 rounded-lg overflow-hidden cursor-pointer"></div>
                            <div id="tooltip-${originalId}" class="absolute hidden pointer-events-none px-2 py-1 rounded bg-gray-900 text-white text-xs font-mono shadow-lg border border-white/20 whitespace-nowrap z-10" style="transform: translateX(-50%); top: -28px;"></div>
                        </div>
                        <div class="flex items-center justify-between mt-3">
                            <button id="play-btn-${originalId}"
                                    class="w-10 h-10 rounded-full bg-cyan-500/20 flex items-center justify-center hover:scale-105 transition-transform">
                                <svg id="play-icon-${originalId}" class="w-5 h-5 text-cyan-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                                <svg id="pause-icon-${originalId}" class="w-5 h-5 text-cyan-400 hidden" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                                </svg>
                            </button>
                            <div class="text-sm text-gray-400 font-mono">
                                <span id="time-${originalId}">0:00</span> /
                                <span id="duration-${originalId}">${track.duration ? formatTime(track.duration) : '‚Äî'}</span>
                            </div>
                        </div>
                    `;
                    container.appendChild(originalCard);

                    // Initialize Regions plugin for original
                    const originalRegions = WaveSurfer.Regions.create();

                    // Initialize WaveSurfer for original
                    const originalWs = WaveSurfer.create({
                        container: `#waveform-${originalId}`,
                        waveColor: '#22d3d1',
                        progressColor: '#06b6d4',
                        cursorColor: '#ffffff',
                        barWidth: 2,
                        barGap: 1,
                        barRadius: 2,
                        height: 64,
                        normalize: true,
                        plugins: [originalRegions]
                    });

                    originalWs.load(`/output/${encodeURIComponent(track.name)}/${track.original_filename}`);
                    originalWs.trackName = track.name;
                    originalWs.stemName = 'original';

                    originalWs.on('ready', () => {
                        document.getElementById(`duration-${originalId}`).textContent = formatTime(originalWs.getDuration());

                        // Setup tooltip and shift+drag for region selection
                        const waveformEl = document.getElementById(`waveform-${originalId}`);
                        const waveformContainer = document.getElementById(`waveform-container-${originalId}`);
                        const tooltip = document.getElementById(`tooltip-${originalId}`);
                        const duration = originalWs.getDuration();

                        // Setup tooltip
                        waveformEl.addEventListener('mousemove', (e) => {
                            const rect = waveformEl.getBoundingClientRect();
                            const x = e.clientX - rect.left;
                            const percentage = x / rect.width;
                            const time = percentage * duration;
                            const mins = Math.floor(time / 60);
                            const secs = Math.floor(time % 60);
                            const ms = Math.floor((time % 1) * 1000);
                            tooltip.textContent = `${mins}:${secs.toString().padStart(2, '0')}.${ms.toString().padStart(3, '0')}`;
                            tooltip.style.left = `${x}px`;
                            tooltip.classList.remove('hidden');
                        });

                        waveformEl.addEventListener('mouseleave', () => tooltip.classList.add('hidden'));

                        // Setup shift+drag region selection
                        setupRegionSelection(originalId, originalWs, originalRegions, (region) => {
                            const sampleBtn = document.getElementById(`sample-btn-${originalId}`);
                            const sampleBtnText = document.getElementById(`sample-btn-text-${originalId}`);
                            sampleBtn.classList.remove('hidden');
                            sampleBtnText.textContent = `Sample (${(region.end - region.start).toFixed(2)}s)`;
                            document.getElementById(`loop-controls-${originalId}`).classList.remove('hidden');
                        }, (region) => {
                            // Update sample button when region is adjusted
                            document.getElementById(`sample-btn-text-${originalId}`).textContent = `Sample (${(region.end - region.start).toFixed(2)}s)`;
                        });
                    });

                    originalRegions.on('region-double-clicked', (region) => region.play());

                    // Sample button handler for original
                    document.getElementById(`sample-btn-${originalId}`).onclick = async function() {
                        if (!activeRegions[originalId]) return;
                        this.disabled = true;
                        const sampleBtnText = document.getElementById(`sample-btn-text-${originalId}`);
                        const originalText = sampleBtnText.textContent;
                        sampleBtnText.textContent = 'Creating...';

                        try {
                            const formData = new FormData();
                            formData.append('track_name', originalWs.trackName);
                            formData.append('stem_name', 'original');
                            formData.append('start_time', activeRegions[originalId].start);
                            formData.append('end_time', activeRegions[originalId].end);

                            const response = await fetch('/sample', { method: 'POST', body: formData });
                            if (response.ok) {
                                const data = await response.json();
                                const link = document.createElement('a');
                                link.href = data.sample_url;
                                link.download = data.sample_name;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                sampleBtnText.textContent = 'Downloaded!';
                                setTimeout(() => sampleBtnText.textContent = originalText, 2000);
                                loadSamples();
                            } else {
                                const error = await response.json();
                                alert('Failed to create sample: ' + (error.detail || 'Unknown error'));
                                sampleBtnText.textContent = originalText;
                            }
                        } catch (error) {
                            alert('Failed to create sample: ' + error.message);
                            sampleBtnText.textContent = originalText;
                        } finally {
                            this.disabled = false;
                        }
                    };

                    // Loop button handler for original
                    document.getElementById(`stem-loop-btn-${originalId}`).onclick = async function() {
                        if (!activeRegions[originalId]) return;
                        const loopCount = parseInt(document.getElementById(`stem-loop-count-${originalId}`).value);
                        this.disabled = true;
                        this.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2" stroke-dasharray="30 60"/></svg>';

                        await createLoop('stem', originalWs.trackName, 'original', activeRegions[originalId].start, activeRegions[originalId].end, loopCount);

                        this.disabled = false;
                        this.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16"><path d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m3.81.086a.5.5 0 0 1 .67.225A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.25.25 0 0 1 0-.384l2.36-1.966a.25.25 0 0 1 .41.192V12h6a4 4 0 0 0 3.585-5.777.5.5 0 0 1 .225-.67Z"/></svg>';
                    };

                    // Play/pause for original
                    const playBtn = document.getElementById(`play-btn-${originalId}`);
                    const playIcon = document.getElementById(`play-icon-${originalId}`);
                    const pauseIcon = document.getElementById(`pause-icon-${originalId}`);

                    playBtn.onclick = () => originalWs.playPause();
                    originalWs.on('play', () => { playIcon.classList.add('hidden'); pauseIcon.classList.remove('hidden'); });
                    originalWs.on('pause', () => { playIcon.classList.remove('hidden'); pauseIcon.classList.add('hidden'); });
                    originalWs.on('audioprocess', () => document.getElementById(`time-${originalId}`).textContent = formatTime(originalWs.getCurrentTime()));
                    originalWs.on('seeking', () => document.getElementById(`time-${originalId}`).textContent = formatTime(originalWs.getCurrentTime()));

                    crateWavesurfers[trackId].push(originalWs);
                }

                track.stems.forEach((stem, index) => {
                    const uniqueId = `crate-${trackId}-${index}`;
                    const icon = stemIcons[stem.name] || stemIcons.other;

                    const card = document.createElement('div');
                    card.className = 'stem-card rounded-xl p-4';
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-lg ${icon.color} flex items-center justify-center">
                                    <span class="text-lg">${icon.emoji}</span>
                                </div>
                                <span class="font-medium ${icon.text} capitalize">${stem.name}</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="sample-btn-${uniqueId}"
                                        class="hidden px-3 py-1.5 rounded-lg bg-emerald-500/20 hover:bg-emerald-500/30 transition-colors text-emerald-400 text-sm font-medium"
                                        title="Download selected region as sample">
                                    <span class="flex items-center space-x-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                        </svg>
                                        <span id="sample-btn-text-${uniqueId}">Sample</span>
                                    </span>
                                </button>
                                <div id="loop-controls-${uniqueId}" class="hidden flex items-center space-x-1 px-2 py-1 rounded-lg bg-purple-500/20">
                                    <select id="stem-loop-count-${uniqueId}"
                                            class="bg-transparent text-purple-400 text-xs font-medium focus:outline-none cursor-pointer">
                                        <option value="2">x2</option>
                                        <option value="4" selected>x4</option>
                                        <option value="8">x8</option>
                                        <option value="16">x16</option>
                                    </select>
                                    <button id="stem-loop-btn-${uniqueId}"
                                            class="text-purple-400 hover:text-purple-300 transition-colors"
                                            title="Create loop from selection">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m3.81.086a.5.5 0 0 1 .67.225A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.25.25 0 0 1 0-.384l2.36-1.966a.25.25 0 0 1 .41.192V12h6a4 4 0 0 0 3.585-5.777.5.5 0 0 1 .225-.67Z"/>
                                        </svg>
                                    </button>
                                </div>
                                <a href="/output/${encodeURIComponent(track.name)}/${stem.filename}"
                                   download="${track.name} - ${stem.name}.wav"
                                   class="p-2 rounded-lg bg-white/5 hover:bg-white/10 transition-colors"
                                   title="Download full stem">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">Shift + drag to select region | Esc to clear</div>
                        <div id="waveform-container-${uniqueId}" class="relative w-full">
                            <div id="waveform-${uniqueId}" class="w-full h-16 rounded-lg overflow-hidden cursor-pointer"></div>
                            <div id="tooltip-${uniqueId}" class="absolute hidden pointer-events-none px-2 py-1 rounded bg-gray-900 text-white text-xs font-mono shadow-lg border border-white/20 whitespace-nowrap z-10" style="transform: translateX(-50%); top: -28px;"></div>
                        </div>
                        <div class="flex items-center justify-between mt-3">
                            <button id="play-btn-${uniqueId}"
                                    class="w-10 h-10 rounded-full ${icon.color} flex items-center justify-center hover:scale-105 transition-transform">
                                <svg id="play-icon-${uniqueId}" class="w-5 h-5 ${icon.text}" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                                <svg id="pause-icon-${uniqueId}" class="w-5 h-5 ${icon.text} hidden" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                                </svg>
                            </button>
                            <div class="text-sm text-gray-400 font-mono">
                                <span id="time-${uniqueId}">0:00</span> /
                                <span id="duration-${uniqueId}">${stem.duration ? formatTime(stem.duration) : '‚Äî'}</span>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);

                    // Initialize Regions plugin
                    const regions = WaveSurfer.Regions.create();

                    // Initialize WaveSurfer with regions plugin
                    const ws = WaveSurfer.create({
                        container: `#waveform-${uniqueId}`,
                        waveColor: getComputedColor(icon.text),
                        progressColor: adjustColor(getComputedColor(icon.text), 1.3),
                        cursorColor: '#ffffff',
                        barWidth: 2,
                        barGap: 1,
                        barRadius: 2,
                        height: 64,
                        normalize: true,
                        plugins: [regions]
                    });

                    ws.load(`/output/${encodeURIComponent(track.name)}/${stem.filename}`);

                    // Store track/stem info on the wavesurfer instance for later use
                    ws.trackName = track.name;
                    ws.stemName = stem.name;

                    // Region is tracked globally via activeRegions[uniqueId]

                    // Enable region creation on shift+drag
                    ws.on('ready', () => {
                        document.getElementById(`duration-${uniqueId}`).textContent = formatTime(ws.getDuration());

                        // Setup time tooltip on hover
                        const waveformContainer = document.getElementById(`waveform-container-${uniqueId}`);
                        const waveformEl = document.getElementById(`waveform-${uniqueId}`);
                        const tooltip = document.getElementById(`tooltip-${uniqueId}`);
                        const duration = ws.getDuration();

                        // Setup tooltip
                        waveformEl.addEventListener('mousemove', (e) => {
                            const rect = waveformEl.getBoundingClientRect();
                            const x = e.clientX - rect.left;
                            const percentage = x / rect.width;
                            const time = percentage * duration;

                            const mins = Math.floor(time / 60);
                            const secs = Math.floor(time % 60);
                            const ms = Math.floor((time % 1) * 1000);
                            tooltip.textContent = `${mins}:${secs.toString().padStart(2, '0')}.${ms.toString().padStart(3, '0')}`;
                            tooltip.style.left = `${x}px`;
                            tooltip.classList.remove('hidden');
                        });

                        waveformEl.addEventListener('mouseleave', () => {
                            tooltip.classList.add('hidden');
                        });

                        // Setup shift+drag region selection
                        setupRegionSelection(uniqueId, ws, regions, (region) => {
                            const sampleBtn = document.getElementById(`sample-btn-${uniqueId}`);
                            const sampleBtnText = document.getElementById(`sample-btn-text-${uniqueId}`);
                            sampleBtn.classList.remove('hidden');
                            sampleBtnText.textContent = `Sample (${(region.end - region.start).toFixed(2)}s)`;
                            document.getElementById(`loop-controls-${uniqueId}`).classList.remove('hidden');
                        }, (region) => {
                            // Update sample button when region is adjusted
                            const sampleBtnText = document.getElementById(`sample-btn-text-${uniqueId}`);
                            sampleBtnText.textContent = `Sample (${(region.end - region.start).toFixed(2)}s)`;
                        });
                    });

                    // Double-click region to play it
                    regions.on('region-double-clicked', (region) => {
                        region.play();
                    });

                    // Sample button click handler
                    const sampleBtn = document.getElementById(`sample-btn-${uniqueId}`);
                    sampleBtn.onclick = async () => {
                        if (!activeRegions[uniqueId]) return;

                        sampleBtn.disabled = true;
                        const sampleBtnText = document.getElementById(`sample-btn-text-${uniqueId}`);
                        const originalText = sampleBtnText.textContent;
                        sampleBtnText.textContent = 'Creating...';

                        try {
                            const formData = new FormData();
                            formData.append('track_name', ws.trackName);
                            formData.append('stem_name', ws.stemName);
                            formData.append('start_time', activeRegions[uniqueId].start);
                            formData.append('end_time', activeRegions[uniqueId].end);

                            const response = await fetch('/sample', {
                                method: 'POST',
                                body: formData
                            });

                            if (response.ok) {
                                const data = await response.json();
                                // Trigger download
                                const link = document.createElement('a');
                                link.href = data.sample_url;
                                link.download = data.sample_name;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                sampleBtnText.textContent = 'Downloaded!';
                                setTimeout(() => {
                                    sampleBtnText.textContent = originalText;
                                }, 2000);
                                // Refresh samples list
                                loadSamples();
                            } else {
                                const error = await response.json();
                                alert('Failed to create sample: ' + (error.detail || 'Unknown error'));
                                sampleBtnText.textContent = originalText;
                            }
                        } catch (error) {
                            alert('Failed to create sample: ' + error.message);
                            sampleBtnText.textContent = originalText;
                        } finally {
                            sampleBtn.disabled = false;
                        }
                    };

                    // Stem loop button click handler
                    const stemLoopBtn = document.getElementById(`stem-loop-btn-${uniqueId}`);
                    const stemLoopCountSelect = document.getElementById(`stem-loop-count-${uniqueId}`);

                    stemLoopBtn.onclick = async () => {
                        if (!activeRegions[uniqueId]) return;

                        const loopCount = parseInt(stemLoopCountSelect.value);
                        stemLoopBtn.disabled = true;
                        stemLoopBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2" stroke-dasharray="30 60"/></svg>';

                        const success = await createLoop(
                            'stem',
                            ws.trackName,
                            ws.stemName,
                            activeRegions[uniqueId].start,
                            activeRegions[uniqueId].end,
                            loopCount
                        );

                        stemLoopBtn.disabled = false;
                        stemLoopBtn.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16"><path d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m3.81.086a.5.5 0 0 1 .67.225A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.25.25 0 0 1 0-.384l2.36-1.966a.25.25 0 0 1 .41.192V12h6a4 4 0 0 0 3.585-5.777.5.5 0 0 1 .225-.67Z"/></svg>';
                    };

                    // Play/pause
                    const playBtn = document.getElementById(`play-btn-${uniqueId}`);
                    const playIcon = document.getElementById(`play-icon-${uniqueId}`);
                    const pauseIcon = document.getElementById(`pause-icon-${uniqueId}`);

                    playBtn.onclick = () => ws.playPause();

                    ws.on('play', () => {
                        playIcon.classList.add('hidden');
                        pauseIcon.classList.remove('hidden');
                    });

                    ws.on('pause', () => {
                        playIcon.classList.remove('hidden');
                        pauseIcon.classList.add('hidden');
                    });

                    ws.on('audioprocess', () => {
                        document.getElementById(`time-${uniqueId}`).textContent = formatTime(ws.getCurrentTime());
                    });

                    ws.on('seeking', () => {
                        document.getElementById(`time-${uniqueId}`).textContent = formatTime(ws.getCurrentTime());
                    });

                    crateWavesurfers[trackId].push(ws);
                });
            } catch (error) {
                container.innerHTML = '<div class="text-red-400 text-sm p-4">Failed to load stems</div>';
            }
        }

        async function deleteTrack(trackId, trackName) {
            if (!confirm(`Delete "${trackName}" and all its stems?\n\nThis cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/crate/${trackId}`, { method: 'DELETE' });

                if (response.ok) {
                    // Clean up wavesurfers for this track
                    if (crateWavesurfers[trackId]) {
                        crateWavesurfers[trackId].forEach(ws => ws.destroy());
                        delete crateWavesurfers[trackId];
                    }
                    delete expandedTracks[trackId];

                    // Remove from local data and re-render
                    crateData = crateData.filter(t => t.id !== trackId);

                    if (crateData.length === 0) {
                        document.getElementById('crate-section').classList.add('hidden');
                    } else {
                        renderCrate();
                    }
                } else {
                    const error = await response.json();
                    alert('Failed to delete track: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to delete track: ' + error.message);
            }
        }

        // Samples functions
        async function loadSamples() {
            try {
                const response = await fetch('/samples');
                const data = await response.json();

                if (data.has_samples && data.samples.length > 0) {
                    samplesData = data.samples;
                    renderSamples();
                    document.getElementById('samples-section').classList.remove('hidden');
                } else {
                    document.getElementById('samples-section').classList.add('hidden');
                }
            } catch (error) {
                console.error('Failed to load samples:', error);
            }
        }

        function renderSamples() {
            const list = document.getElementById('samples-list');
            list.innerHTML = '';

            document.getElementById('samples-count').textContent =
                `${samplesData.length} sample${samplesData.length !== 1 ? 's' : ''}`;

            samplesData.forEach((sample, index) => {
                const uniqueId = `sample-${sample.id}`;
                const icon = stemIcons[sample.stem_name] || stemIcons.other;

                const card = document.createElement('div');
                card.className = 'stem-card rounded-xl p-4 overflow-hidden';
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-3 gap-3">
                        <div class="flex items-center space-x-3 min-w-0 flex-1">
                            <div class="w-10 h-10 rounded-lg ${icon.color} flex items-center justify-center flex-shrink-0">
                                <span class="text-lg">${icon.emoji}</span>
                            </div>
                            <div class="min-w-0 flex-1">
                                <div class="font-medium text-white truncate">${sample.track_name}</div>
                                <div class="text-xs text-gray-400 truncate">
                                    <span class="${icon.text} capitalize">${sample.stem_name}</span>
                                    <span class="text-gray-500 ml-2">${sample.start_time.toFixed(2)}s - ${sample.end_time.toFixed(2)}s</span>
                                    <span class="text-emerald-400 ml-2">(${sample.duration.toFixed(2)}s)</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 flex-shrink-0">
                            <a href="/samples-files/${encodeURIComponent(sample.filename)}"
                               download="${sample.filename}"
                               class="p-2 rounded-lg bg-white/5 hover:bg-white/10 transition-colors"
                               title="Download sample">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                            </a>
                            <button onclick="deleteSample(${sample.id}, '${sample.filename.replace(/'/g, "\\'")}')"
                                    class="p-2 rounded-lg bg-white/5 hover:bg-red-500/20 transition-colors group"
                                    title="Delete sample">
                                <svg class="w-5 h-5 text-gray-400 group-hover:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="relative">
                        <div id="waveform-${uniqueId}" class="w-full h-12 rounded-lg overflow-hidden"></div>
                    </div>
                    <div class="flex items-center justify-between mt-3">
                        <div class="flex items-center space-x-2">
                            <button id="play-btn-${uniqueId}"
                                    class="w-8 h-8 rounded-full ${icon.color} flex items-center justify-center hover:scale-105 transition-transform">
                                <svg id="play-icon-${uniqueId}" class="w-4 h-4 ${icon.text}" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                                <svg id="pause-icon-${uniqueId}" class="w-4 h-4 ${icon.text} hidden" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                                </svg>
                            </button>
                            <!-- Sample button (hidden until region selected) -->
                            <button id="sample-btn-${uniqueId}" class="hidden px-3 py-1.5 rounded-lg bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 text-xs font-medium transition-colors" title="Download selected region as sample">
                                <span class="flex items-center space-x-1">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                    </svg>
                                    <span id="sample-btn-text-${uniqueId}">Sample</span>
                                </span>
                            </button>
                            <!-- Loop controls for region (hidden until region selected) -->
                            <div id="loop-controls-${uniqueId}" class="hidden flex items-center space-x-1 bg-purple-500/10 rounded-lg px-2 py-1">
                                <select id="region-loop-count-${uniqueId}"
                                        class="bg-transparent text-purple-400 text-xs font-medium focus:outline-none cursor-pointer">
                                    <option value="2">x2</option>
                                    <option value="4" selected>x4</option>
                                    <option value="8">x8</option>
                                    <option value="16">x16</option>
                                </select>
                                <button id="region-loop-btn-${uniqueId}"
                                        class="text-purple-400 hover:text-purple-300 transition-colors"
                                        title="Create loop from selection">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m3.81.086a.5.5 0 0 1 .67.225A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.25.25 0 0 1 0-.384l2.36-1.966a.25.25 0 0 1 .41.192V12h6a4 4 0 0 0 3.585-5.777.5.5 0 0 1 .225-.67Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="text-xs text-gray-400 font-mono">
                            <span id="time-${uniqueId}">0:00</span> /
                            <span id="duration-${uniqueId}">${formatTime(sample.duration)}</span>
                        </div>
                    </div>
                `;
                list.appendChild(card);

                // Initialize WaveSurfer for this sample
                const ws = WaveSurfer.create({
                    container: `#waveform-${uniqueId}`,
                    waveColor: getComputedColor(icon.text),
                    progressColor: adjustColor(getComputedColor(icon.text), 1.3),
                    cursorColor: '#ffffff',
                    barWidth: 2,
                    barGap: 1,
                    barRadius: 2,
                    height: 48,
                    normalize: true
                });

                ws.load(`/samples-files/${encodeURIComponent(sample.filename)}`);

                // Play/pause
                const playBtn = document.getElementById(`play-btn-${uniqueId}`);
                const playIcon = document.getElementById(`play-icon-${uniqueId}`);
                const pauseIcon = document.getElementById(`pause-icon-${uniqueId}`);

                playBtn.onclick = () => ws.playPause();

                ws.on('play', () => {
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                });

                ws.on('pause', () => {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                });

                ws.on('audioprocess', () => {
                    document.getElementById(`time-${uniqueId}`).textContent = formatTime(ws.getCurrentTime());
                });

                ws.on('seeking', () => {
                    document.getElementById(`time-${uniqueId}`).textContent = formatTime(ws.getCurrentTime());
                });

                ws.on('ready', () => {
                    document.getElementById(`duration-${uniqueId}`).textContent = formatTime(ws.getDuration());

                    // Register regions plugin and setup region selection
                    const regions = ws.registerPlugin(WaveSurfer.Regions.create());

                    setupRegionSelection(uniqueId, ws, regions, (region) => {
                        // Show sample button and loop controls when region created
                        const sampleBtn = document.getElementById(`sample-btn-${uniqueId}`);
                        const sampleBtnText = document.getElementById(`sample-btn-text-${uniqueId}`);
                        const loopControls = document.getElementById(`loop-controls-${uniqueId}`);
                        sampleBtn.classList.remove('hidden');
                        loopControls.classList.remove('hidden');
                        sampleBtnText.textContent = `Sample (${(region.end - region.start).toFixed(2)}s)`;
                    }, (region) => {
                        // Update sample button when region adjusted
                        const sampleBtnText = document.getElementById(`sample-btn-text-${uniqueId}`);
                        sampleBtnText.textContent = `Sample (${(region.end - region.start).toFixed(2)}s)`;
                    });

                    // Double-click region to play
                    regions.on('region-double-clicked', (region) => region.play());

                    // Sample button click handler - create sample from sample region
                    document.getElementById(`sample-btn-${uniqueId}`).onclick = async function() {
                        if (!activeRegions[uniqueId]) return;
                        this.disabled = true;
                        const sampleBtnText = document.getElementById(`sample-btn-text-${uniqueId}`);
                        const originalText = sampleBtnText.textContent;
                        sampleBtnText.textContent = 'Creating...';

                        // Calculate absolute times within the original stem
                        const absoluteStart = sample.start_time + activeRegions[uniqueId].start;
                        const absoluteEnd = sample.start_time + activeRegions[uniqueId].end;

                        try {
                            const formData = new FormData();
                            formData.append('track_name', sample.track_name);
                            formData.append('stem_name', sample.stem_name);
                            formData.append('start_time', absoluteStart);
                            formData.append('end_time', absoluteEnd);

                            const response = await fetch('/sample', { method: 'POST', body: formData });
                            if (response.ok) {
                                const data = await response.json();
                                const link = document.createElement('a');
                                link.href = data.sample_url;
                                link.download = data.sample_name;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                sampleBtnText.textContent = 'Downloaded!';
                                setTimeout(() => sampleBtnText.textContent = originalText, 2000);
                                loadSamples();
                            } else {
                                const error = await response.json();
                                alert('Failed to create sample: ' + (error.detail || 'Unknown error'));
                                sampleBtnText.textContent = originalText;
                            }
                        } catch (error) {
                            alert('Failed to create sample: ' + error.message);
                            sampleBtnText.textContent = originalText;
                        } finally {
                            this.disabled = false;
                        }
                    };

                    // Region loop button click handler - create loop from sample region
                    document.getElementById(`region-loop-btn-${uniqueId}`).onclick = async function() {
                        if (!activeRegions[uniqueId]) return;
                        const loopCount = parseInt(document.getElementById(`region-loop-count-${uniqueId}`).value);
                        this.disabled = true;
                        this.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2" stroke-dasharray="30 60"/></svg>';

                        // Calculate absolute times within the original stem
                        const absoluteStart = sample.start_time + activeRegions[uniqueId].start;
                        const absoluteEnd = sample.start_time + activeRegions[uniqueId].end;

                        const success = await createLoop(
                            'stem',  // Use stem source since we're using absolute times
                            sample.track_name,
                            sample.stem_name,
                            absoluteStart,
                            absoluteEnd,
                            loopCount
                        );

                        this.disabled = false;
                        this.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16"><path d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m3.81.086a.5.5 0 0 1 .67.225A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.25.25 0 0 1 0-.384l2.36-1.966a.25.25 0 0 1 .41.192V12h6a4 4 0 0 0 3.585-5.777.5.5 0 0 1 .225-.67Z"/></svg>';
                    };
                });

                sampleWavesurfers[sample.id] = ws;
            });
        }

        async function deleteSample(sampleId, filename) {
            if (!confirm(`Delete sample "${filename}"?\n\nThis cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/samples/${sampleId}`, { method: 'DELETE' });

                if (response.ok) {
                    // Clean up wavesurfer
                    if (sampleWavesurfers[sampleId]) {
                        sampleWavesurfers[sampleId].destroy();
                        delete sampleWavesurfers[sampleId];
                    }

                    // Remove from local data and re-render
                    samplesData = samplesData.filter(s => s.id !== sampleId);

                    if (samplesData.length === 0) {
                        document.getElementById('samples-section').classList.add('hidden');
                    } else {
                        renderSamples();
                    }
                } else {
                    const error = await response.json();
                    alert('Failed to delete sample: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to delete sample: ' + error.message);
            }
        }

        // Loops functions
        async function loadLoops() {
            try {
                const response = await fetch('/loops');
                const data = await response.json();

                if (data.has_loops && data.loops.length > 0) {
                    loopsData = data.loops;
                    renderLoops();
                    document.getElementById('loops-section').classList.remove('hidden');
                } else {
                    document.getElementById('loops-section').classList.add('hidden');
                }
            } catch (error) {
                console.error('Failed to load loops:', error);
            }
        }

        function renderLoops() {
            const list = document.getElementById('loops-list');
            list.innerHTML = '';

            document.getElementById('loops-count').textContent =
                `${loopsData.length} loop${loopsData.length !== 1 ? 's' : ''}`;

            loopsData.forEach((loop, index) => {
                const uniqueId = `loop-${loop.id}`;
                const icon = stemIcons[loop.stem_name] || stemIcons.other;

                const card = document.createElement('div');
                card.className = 'stem-card rounded-xl p-4 overflow-hidden';
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-3 gap-3">
                        <div class="flex items-center space-x-3 min-w-0 flex-1">
                            <div class="w-10 h-10 rounded-lg ${icon.color} flex items-center justify-center flex-shrink-0">
                                <span class="text-lg">${icon.emoji}</span>
                            </div>
                            <div class="min-w-0 flex-1">
                                <div class="font-medium text-white truncate">${loop.track_name}</div>
                                <div class="text-xs text-gray-400 truncate">
                                    <span class="${icon.text} capitalize">${loop.stem_name}</span>
                                    <span class="text-gray-500 ml-2">${loop.start_time.toFixed(2)}s - ${loop.end_time.toFixed(2)}s</span>
                                    <span class="${icon.text} ml-2">x${loop.loop_count}</span>
                                    <span class="text-gray-500 ml-2">(${loop.duration.toFixed(2)}s total)</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 flex-shrink-0">
                            <a href="/loops-files/${encodeURIComponent(loop.filename)}"
                               download="${loop.filename}"
                               class="p-2 rounded-lg bg-white/5 hover:bg-white/10 transition-colors"
                               title="Download loop">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                            </a>
                            <button onclick="deleteLoop(${loop.id}, '${loop.filename.replace(/'/g, "\\'")}')"
                                    class="p-2 rounded-lg bg-white/5 hover:bg-red-500/20 transition-colors group"
                                    title="Delete loop">
                                <svg class="w-5 h-5 text-gray-400 group-hover:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="waveform-${uniqueId}" class="w-full h-12 rounded-lg overflow-hidden"></div>
                    <div class="flex items-center justify-between mt-3">
                        <button id="play-btn-${uniqueId}"
                                class="w-8 h-8 rounded-full ${icon.color} flex items-center justify-center hover:scale-105 transition-transform">
                            <svg id="play-icon-${uniqueId}" class="w-4 h-4 ${icon.text}" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                            <svg id="pause-icon-${uniqueId}" class="w-4 h-4 ${icon.text} hidden" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                            </svg>
                        </button>
                        <div class="text-xs text-gray-400 font-mono">
                            <span id="time-${uniqueId}">0:00</span> /
                            <span id="duration-${uniqueId}">${formatTime(loop.duration)}</span>
                        </div>
                    </div>
                `;
                list.appendChild(card);

                // Initialize WaveSurfer for this loop
                const ws = WaveSurfer.create({
                    container: `#waveform-${uniqueId}`,
                    waveColor: getComputedColor(icon.text),
                    progressColor: adjustColor(getComputedColor(icon.text), 1.3),
                    cursorColor: '#ffffff',
                    barWidth: 2,
                    barGap: 1,
                    barRadius: 2,
                    height: 48,
                    normalize: true
                });

                ws.load(`/loops-files/${encodeURIComponent(loop.filename)}`);

                // Play/pause
                const playBtn = document.getElementById(`play-btn-${uniqueId}`);
                const playIcon = document.getElementById(`play-icon-${uniqueId}`);
                const pauseIcon = document.getElementById(`pause-icon-${uniqueId}`);

                playBtn.onclick = () => ws.playPause();

                ws.on('play', () => {
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                });

                ws.on('pause', () => {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                });

                ws.on('audioprocess', () => {
                    document.getElementById(`time-${uniqueId}`).textContent = formatTime(ws.getCurrentTime());
                });

                ws.on('seeking', () => {
                    document.getElementById(`time-${uniqueId}`).textContent = formatTime(ws.getCurrentTime());
                });

                ws.on('ready', () => {
                    document.getElementById(`duration-${uniqueId}`).textContent = formatTime(ws.getDuration());
                });

                loopWavesurfers[loop.id] = ws;
            });
        }

        async function deleteLoop(loopId, filename) {
            if (!confirm(`Delete loop "${filename}"?\n\nThis cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/loops/${loopId}`, { method: 'DELETE' });

                if (response.ok) {
                    // Clean up wavesurfer
                    if (loopWavesurfers[loopId]) {
                        loopWavesurfers[loopId].destroy();
                        delete loopWavesurfers[loopId];
                    }

                    // Remove from local data and re-render
                    loopsData = loopsData.filter(l => l.id !== loopId);

                    if (loopsData.length === 0) {
                        document.getElementById('loops-section').classList.add('hidden');
                    } else {
                        renderLoops();
                    }
                } else {
                    const error = await response.json();
                    alert('Failed to delete loop: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to delete loop: ' + error.message);
            }
        }

        async function createLoop(sourceType, trackName, stemName, startTime, endTime, loopCount) {
            const formData = new FormData();
            formData.append('source_type', sourceType);
            formData.append('track_name', trackName);
            formData.append('stem_name', stemName);
            formData.append('start_time', startTime);
            formData.append('end_time', endTime);
            formData.append('loop_count', loopCount);

            try {
                const response = await fetch('/loop', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    // Trigger download
                    const link = document.createElement('a');
                    link.href = data.loop_url;
                    link.download = data.loop_name;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    // Refresh loops list
                    loadLoops();
                    return true;
                } else {
                    const error = await response.json();
                    alert('Failed to create loop: ' + (error.detail || 'Unknown error'));
                    return false;
                }
            } catch (error) {
                alert('Failed to create loop: ' + error.message);
                return false;
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            const fileSection = document.getElementById('file-section');
            const urlSection = document.getElementById('url-section');
            const tabFile = document.getElementById('tab-file');
            const tabUrl = document.getElementById('tab-url');
            const previewSection = document.getElementById('preview-section');

            // Hide preview and clean up WaveSurfer when switching tabs
            previewSection.classList.add('hidden');
            previewReady = false;
            urlFetchData = null;
            if (wavesurfer) {
                wavesurfer.destroy();
                wavesurfer = null;
            }

            if (tab === 'file') {
                fileSection.classList.remove('hidden');
                urlSection.classList.add('hidden');
                tabFile.className = 'px-6 py-2 rounded-lg font-medium transition-all bg-indigo-600 text-white';
                tabUrl.className = 'px-6 py-2 rounded-lg font-medium transition-all bg-white/10 text-gray-300 hover:bg-white/20';
            } else {
                fileSection.classList.add('hidden');
                urlSection.classList.remove('hidden');
                tabUrl.className = 'px-6 py-2 rounded-lg font-medium transition-all bg-indigo-600 text-white';
                tabFile.className = 'px-6 py-2 rounded-lg font-medium transition-all bg-white/10 text-gray-300 hover:bg-white/20';
            }
        }

        // File input handling
        const fileInput = document.getElementById('file-input');
        const uploadZone = document.getElementById('upload-zone');
        const fileLabel = document.getElementById('file-label');

        fileInput.addEventListener('change', async (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                fileLabel.textContent = file.name;
                uploadZone.classList.add('border-indigo-500', 'bg-indigo-500/10');
                await showFilePreview(file);
            }
        });

        // Drag and drop
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });

        uploadZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                fileInput.files = e.dataTransfer.files;
                fileLabel.textContent = file.name;
                uploadZone.classList.add('border-indigo-500', 'bg-indigo-500/10');
                await showFilePreview(file);
            }
        });

        // Initialize or reinitialize WaveSurfer
        function initWaveSurfer() {
            if (wavesurfer) {
                wavesurfer.destroy();
            }

            wavesurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: '#6366f1',
                progressColor: '#a855f7',
                cursorColor: '#ffffff',
                barWidth: 2,
                barGap: 1,
                barRadius: 2,
                height: 96,
                normalize: true,
                backend: 'WebAudio'
            });

            // Play/pause button
            const playBtn = document.getElementById('play-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');

            playBtn.onclick = () => wavesurfer.playPause();

            wavesurfer.on('play', () => {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            });

            wavesurfer.on('pause', () => {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            });

            // Time display
            wavesurfer.on('audioprocess', () => {
                document.getElementById('current-time').textContent = formatTime(wavesurfer.getCurrentTime());
            });

            wavesurfer.on('seeking', () => {
                document.getElementById('current-time').textContent = formatTime(wavesurfer.getCurrentTime());
            });

            wavesurfer.on('ready', () => {
                document.getElementById('duration').textContent = formatTime(wavesurfer.getDuration());
                document.getElementById('waveform-loading').classList.add('hidden');
                document.getElementById('waveform').classList.remove('hidden');
            });

            return wavesurfer;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Precision time format for sample creation (M:SS.mmm)
        function formatTimePrecise(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 1000);
            return `${mins}:${secs.toString().padStart(2, '0')}.${ms.toString().padStart(3, '0')}`;
        }

        // Parse precision time string back to seconds
        function parseTimePrecise(timeStr) {
            const match = timeStr.match(/^(\d+):(\d{2})\.(\d{3})$/);
            if (!match) return null;
            const mins = parseInt(match[1], 10);
            const secs = parseInt(match[2], 10);
            const ms = parseInt(match[3], 10);
            return mins * 60 + secs + ms / 1000;
        }

        // Show preview for uploaded file
        async function showFilePreview(file) {
            const previewSection = document.getElementById('preview-section');
            const waveformLoading = document.getElementById('waveform-loading');
            const waveformEl = document.getElementById('waveform');
            const bpmDisplay = document.getElementById('bpm-display');
            const trackInfo = document.getElementById('track-info');

            // Hide track info for file uploads (no metadata)
            trackInfo.classList.add('hidden');

            // Show section with loading state
            previewSection.classList.remove('hidden');
            waveformEl.classList.add('hidden');
            waveformLoading.classList.remove('hidden');
            bpmDisplay.textContent = 'Analyzing...';
            previewReady = false;

            // Initialize WaveSurfer and load file
            initWaveSurfer();
            wavesurfer.loadBlob(file);

            // Call analyze endpoint for BPM
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/analyze', { method: 'POST', body: formData });
                const data = await response.json();

                if (response.ok) {
                    bpmDisplay.textContent = `${Math.round(data.bpm)} BPM`;
                    previewReady = true;
                } else {
                    bpmDisplay.textContent = 'Analysis failed';
                }
            } catch (error) {
                bpmDisplay.textContent = 'Analysis failed';
            }
        }

        // Fetch and analyze audio from URL
        async function fetchFromUrl() {
            const urlInput = document.getElementById('url-input');
            const url = urlInput.value.trim();
            const fetchBtn = document.getElementById('fetch-url-btn');
            const fetchBtnText = document.getElementById('fetch-btn-text');

            if (!url) {
                alert('Please enter a URL');
                return;
            }

            // Show loading state
            fetchBtn.disabled = true;
            fetchBtnText.textContent = 'Fetching...';

            const previewSection = document.getElementById('preview-section');
            const waveformLoading = document.getElementById('waveform-loading');
            const waveformEl = document.getElementById('waveform');
            const bpmDisplay = document.getElementById('bpm-display');

            // Show preview section with loading state
            previewSection.classList.remove('hidden');
            waveformEl.classList.add('hidden');
            waveformLoading.classList.remove('hidden');
            bpmDisplay.textContent = 'Downloading & analyzing...';
            previewReady = false;

            try {
                const formData = new FormData();
                formData.append('url', url);

                const response = await fetch('/fetch-url', { method: 'POST', body: formData });
                const data = await response.json();

                if (response.ok) {
                    // Store data for later use in form submission
                    urlFetchData = data;

                    // Show track info if available
                    const trackInfo = document.getElementById('track-info');
                    if (data.thumbnail) {
                        document.getElementById('track-thumbnail').src = data.thumbnail;
                        document.getElementById('track-title').textContent = data.title || 'Unknown Title';
                        document.getElementById('track-artist').textContent = data.artist || 'Unknown Artist';
                        trackInfo.classList.remove('hidden');
                    } else {
                        trackInfo.classList.add('hidden');
                    }

                    // Initialize WaveSurfer and load from URL
                    initWaveSurfer();
                    wavesurfer.load(data.audio_url);

                    bpmDisplay.textContent = `${Math.round(data.bpm)} BPM`;
                    previewReady = true;

                    fetchBtnText.textContent = 'Fetched!';
                } else {
                    throw new Error(data.detail || 'Failed to fetch URL');
                }
            } catch (error) {
                bpmDisplay.textContent = 'Fetch failed';
                waveformLoading.classList.add('hidden');
                previewSection.classList.add('hidden');
                alert('Failed to fetch audio: ' + error.message);
                fetchBtnText.textContent = 'Fetch Audio';
            } finally {
                fetchBtn.disabled = false;
            }
        }

        // Form submission
        document.getElementById('upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            const numStems = document.querySelector('input[name="num_stems"]:checked').value;
            formData.append('num_stems', numStems);

            if (currentTab === 'file') {
                const file = fileInput.files[0];
                if (!file) {
                    alert('Please select a file');
                    return;
                }
                if (!previewReady) {
                    alert('Please wait for audio analysis to complete');
                    return;
                }
                formData.append('file', file);
            } else {
                // URL tab - use pre-fetched data
                if (!urlFetchData) {
                    alert('Please fetch audio from URL first');
                    return;
                }
                // Pass the already-downloaded file path to the backend
                formData.append('fetched_job_id', urlFetchData.job_id);
                formData.append('fetched_audio_path', urlFetchData.audio_path);
            }

            // Show processing state
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('status-section').classList.remove('hidden');
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('error-section').classList.add('hidden');

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    currentJobId = data.job_id;
                    startPolling();
                } else {
                    showError(data.detail || 'Upload failed');
                }
            } catch (error) {
                showError(error.message);
            }
        });

        function startPolling() {
            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/status/${currentJobId}`);
                    const data = await response.json();

                    document.getElementById('status-message').textContent = data.message;

                    if (data.status === 'completed') {
                        clearInterval(pollInterval);
                        showResults(data);
                    } else if (data.status === 'error') {
                        clearInterval(pollInterval);
                        showError(data.message);
                    }
                } catch (error) {
                    clearInterval(pollInterval);
                    showError(error.message);
                }
            }, 1000);
        }

        function showResults(data) {
            document.getElementById('status-section').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');

            // Clean up any existing stem wavesurfers
            stemWavesurfers.forEach(ws => ws.destroy());
            stemWavesurfers = [];

            const grid = document.getElementById('stems-grid');
            grid.innerHTML = '';

            let stemIndex = 0;
            for (const [name, url] of Object.entries(data.stems)) {
                const icon = stemIcons[name] || stemIcons.other;
                const uniqueId = `stem-${stemIndex}`;
                const card = document.createElement('div');
                card.className = 'stem-card rounded-xl p-5 transition-all';
                card.innerHTML = `
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="stem-icon ${icon.color}">
                            <span>${icon.emoji}</span>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg capitalize ${icon.text}">${name}</h3>
                            <p class="text-sm text-gray-500">${getStemDescription(name)}</p>
                        </div>
                        <a href="${url}" download class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-all" title="Download">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                        </a>
                    </div>
                    <div id="waveform-${uniqueId}" class="w-full rounded-lg overflow-hidden mb-3"></div>
                    <div class="flex items-center space-x-3">
                        <button id="play-btn-${uniqueId}" type="button"
                                class="p-2 rounded-full ${icon.color} hover:opacity-80 transition-all">
                            <svg id="play-icon-${uniqueId}" class="w-4 h-4 ${icon.text}" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                            <svg id="pause-icon-${uniqueId}" class="w-4 h-4 ${icon.text} hidden" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                            </svg>
                        </button>
                        <div id="time-${uniqueId}" class="text-xs text-gray-400 font-mono">0:00</div>
                        <div class="flex-1"></div>
                        <div id="duration-${uniqueId}" class="text-xs text-gray-400 font-mono">0:00</div>
                    </div>
                `;
                grid.appendChild(card);

                // Create WaveSurfer for this stem
                const ws = WaveSurfer.create({
                    container: `#waveform-${uniqueId}`,
                    waveColor: getComputedColor(icon.text),
                    progressColor: adjustColor(getComputedColor(icon.text), 1.3),
                    cursorColor: '#ffffff',
                    barWidth: 2,
                    barGap: 1,
                    barRadius: 2,
                    height: 64,
                    normalize: true
                });

                ws.load(url);

                // Play/pause
                const playBtn = document.getElementById(`play-btn-${uniqueId}`);
                const playIcon = document.getElementById(`play-icon-${uniqueId}`);
                const pauseIcon = document.getElementById(`pause-icon-${uniqueId}`);

                playBtn.onclick = () => ws.playPause();

                ws.on('play', () => {
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                });

                ws.on('pause', () => {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                });

                ws.on('audioprocess', () => {
                    document.getElementById(`time-${uniqueId}`).textContent = formatTime(ws.getCurrentTime());
                });

                ws.on('seeking', () => {
                    document.getElementById(`time-${uniqueId}`).textContent = formatTime(ws.getCurrentTime());
                });

                ws.on('ready', () => {
                    document.getElementById(`duration-${uniqueId}`).textContent = formatTime(ws.getDuration());
                });

                stemWavesurfers.push(ws);
                stemIndex++;
            }

            // Refresh crate to include the new track
            loadCrate();
        }

        // Helper to get color from Tailwind class
        function getComputedColor(textClass) {
            const colors = {
                'text-pink-400': '#f472b6',
                'text-blue-400': '#60a5fa',
                'text-orange-400': '#fb923c',
                'text-green-400': '#4ade80',
                'text-purple-400': '#c084fc',
                'text-yellow-400': '#facc15'
            };
            return colors[textClass] || '#6366f1';
        }

        // Lighten/darken color for progress
        function adjustColor(hex, factor) {
            const r = Math.min(255, Math.floor(parseInt(hex.slice(1, 3), 16) * factor));
            const g = Math.min(255, Math.floor(parseInt(hex.slice(3, 5), 16) * factor));
            const b = Math.min(255, Math.floor(parseInt(hex.slice(5, 7), 16) * factor));
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }

        function getStemDescription(name) {
            const descriptions = {
                vocals: 'Isolated voice track',
                accompaniment: 'Everything except vocals',
                drums: 'Percussion and drums',
                bass: 'Bass guitar and low frequencies',
                piano: 'Piano and keys',
                other: 'Other instruments'
            };
            return descriptions[name] || 'Audio stem';
        }

        function showError(message) {
            document.getElementById('status-section').classList.add('hidden');
            document.getElementById('error-section').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }

        function resetForm() {
            // Don't delete jobs - tracks should persist in the crate
            // Just clear the current job reference
            currentJobId = null;

            // Clean up URL fetch data (but don't delete - it might be in crate now)
            urlFetchData = null;
            previewReady = false;

            // Clean up WaveSurfer instances
            if (wavesurfer) {
                wavesurfer.destroy();
                wavesurfer = null;
            }
            stemWavesurfers.forEach(ws => ws.destroy());
            stemWavesurfers = [];

            // Clean up crate wavesurfers (keep them around but stop playback)
            Object.values(crateWavesurfers).forEach(wsArray => {
                wsArray.forEach(ws => {
                    if (ws.isPlaying()) ws.pause();
                });
            });

            // Reset UI
            document.getElementById('upload-section').classList.remove('hidden');
            document.getElementById('status-section').classList.add('hidden');
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('error-section').classList.add('hidden');
            document.getElementById('preview-section').classList.add('hidden');
            document.getElementById('track-info').classList.add('hidden');

            // Reset form
            document.getElementById('upload-form').reset();
            fileLabel.textContent = 'Drop your audio file here or click to browse';
            uploadZone.classList.remove('border-indigo-500', 'bg-indigo-500/10');
            document.getElementById('fetch-btn-text').textContent = 'Fetch Audio';
            switchTab('file');
        }
    </script>
</body>
</html>
